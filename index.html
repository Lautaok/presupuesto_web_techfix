<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuestos - Tech-fix</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* TUS ESTILOS (sin cambios) */
        body {
            font-family: 'Roboto', sans-serif;
            background: #020024;
            background: linear-gradient(90deg, rgba(2, 0, 36, 1) 0%, rgba(8, 7, 105, 1) 17%, rgba(9, 9, 121, 1) 89%, rgba(0, 0, 0, 1) 100%);
            color: #333;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        img {
            border-radius: 50%;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #008CBA; }
        .header-print-only { display: none; }
        .comprobante-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #008CBA;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .info-contacto-print {
            line-height: 1.4;
            font-size: 0.9em;
        }
        .info-numeracion {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .numero-comprobante, .fecha-comprobante {
            font-weight: bold;
        }
        .seccion-cliente { margin-bottom: 20px; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; font-family: 'Roboto', sans-serif; box-sizing: border-box; resize: vertical; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f8f8; }
        .descripcion-col { width: 70%; }
        .precio-col { width: 20%; }
        .item-row input { width: 95%; }
        .btn-accion, .btn-remover-item, .btn-guardar { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #btn-agregar-item { background-color: #e0e0e0; margin-top: 10px; }
        .btn-remover-item { background-color: #fdd; }
        .seccion-total { text-align: right; margin-top: 20px; font-size: 1.8em; font-weight: bold; color: #008CBA; }
        .seccion-guardar { text-align: center; margin-top: 30px; }
        .btn-guardar { background-color: #008CBA; color: white; font-size: 1.1em; padding: 15px 30px; }

        /* Estilos de Impresi칩n (no los usaremos para el PDF, pero los dejamos) */
        @media print {
            /* ... */
        }
    </style>
</head>
<body>

    <div class="container" id="presupuesto-container">
        <div class="header no-print">
            <img src="img/logo500x500.png" alt="Logo de Tech-Fix" style="width: 150px; margin-bottom: 10px;">
            <p><strong>Reparaci칩n y Mantenimiento de PC</strong></p>
        </div>
        
        <div style="position: absolute; left: -9999px;">
            <img src="img/logo500x500.png" alt="Logo de Tech-Fix" id="logo-para-canvas" style="width: 150px; border-radius: 50%;">
        </div>

        <div class="comprobante-info">
            <div class="info-contacto-print">
                <strong>Tech-Fix</strong><br>
                <small>Contacto: @tech.fix.ok | Tel: 3888343801</small>
            </div>
            <div class="info-numeracion">
                <div>
                    <span>Presupuesto N춿:</span>
                    <span class="numero-comprobante" id="numero-comprobante"></span>
                </div>
                <div>
                    <span>Fecha:</span>
                    <span class="fecha-comprobante" id="fecha-actual"></span>
                </div>
            </div>
        </div>
        <div class="seccion-cliente">
            <label for="cliente">Cliente:</label>
            <input type="text" id="cliente" required>
        </div>
        <div class="seccion-cliente">
            <label for="equipo">Equipo:</label>
            <textarea id="equipo" rows="1" required></textarea>
        </div>
        <div class="seccion-cliente">
            <label for="falla">Falla a detallar:</label>
            <textarea id="falla" rows="1" required></textarea>
        </div>
        <div class="seccion-detalle">
            <table>
                <thead>
                    <tr>
                        <th class="descripcion-col">Descripci칩n</th>
                        <th class="precio-col">Precio</th>
                        <th class="accion-col no-print"></th>
                    </tr>
                </thead>
                <tbody id="items-container"></tbody>
            </table>
            <button type="button" id="btn-agregar-item" class="btn-accion no-print">+ Agregar 칈tem</button>
        </div>
        <div class="seccion-total">
            <span>TOTAL: $</span>
            <span id="total-presupuesto">0.00</span>
        </div>
        <div class="seccion-guardar no-print">
            <button type="button" id="btn-guardar" class="btn-guardar">游 Generar y Descargar PDF</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const { jsPDF } = window.jspdf;

        // --- CONSTANTES ---
        const btnGuardar = document.getElementById('btn-guardar');
        const itemsContainer = document.getElementById('items-container');
        const btnAgregarItem = document.getElementById('btn-agregar-item');
        const totalPresupuestoEl = document.getElementById('total-presupuesto');
        const clienteInput = document.getElementById('cliente');
        const equipoInput = document.getElementById('equipo');
        const fallaInput = document.getElementById('falla');
        const numeroComprobanteEl = document.getElementById('numero-comprobante');
        const fechaActualEl = document.getElementById('fecha-actual');
        
        // --- FUNCIONES DE L칍GICA (sin cambios) ---
        function getProximoNumero() {
            const ultimoNumero = parseInt(localStorage.getItem('ultimoPresupuestoId') || '0');
            return ultimoNumero + 1;
        }
        function formatarNumero(num) {
            return `0001-${String(num).padStart(8, '0')}`;
        }
        function mostrarFechaActual() {
            const hoy = new Date();
            const dia = String(hoy.getDate()).padStart(2, '0');
            const mes = String(hoy.getMonth() + 1).padStart(2, '0');
            const anio = hoy.getFullYear();
            fechaActualEl.textContent = `${dia}/${mes}/${anio}`;
        }
        const agregarItem = () => {
            const row = document.createElement('tr');
            row.classList.add('item-row');
            row.innerHTML = `
                <td><input type="text" class="item-descripcion" required placeholder="Ej: Cambio de disco duro"></td>
                <td><input type="number" class="item-precio" step="0.01" min="0" required placeholder="0.00"></td>
                <td class="no-print"><button type="button" class="btn-remover-item">X</button></td>
            `;
            itemsContainer.appendChild(row);
        };
        const calcularTotal = () => {
            let total = 0;
            document.querySelectorAll('.item-precio').forEach(input => {
                total += parseFloat(input.value || 0);
            });
            totalPresupuestoEl.textContent = total.toFixed(2);
        };
        const inicializarFormulario = () => {
            clienteInput.value = '';
            equipoInput.value = '';
            fallaInput.value = '';
            itemsContainer.innerHTML = '';
            agregarItem();
            calcularTotal();
            numeroComprobanteEl.textContent = formatarNumero(getProximoNumero());
            mostrarFechaActual();
        };
        
        // --- MANEJO DE EVENTOS (sin cambios) ---
        btnAgregarItem.addEventListener('click', agregarItem);
        itemsContainer.addEventListener('input', calcularTotal);
        itemsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-remover-item') && itemsContainer.children.length > 1) {
                e.target.closest('.item-row').remove();
                calcularTotal();
            }
        });

        // --- FUNCI칍N DE GUARDADO MODIFICADA (ahora es 'async') ---
        btnGuardar.addEventListener('click', async () => {
            // 1. Validar formulario (sin cambios)
            const items = [];
            let formularioValido = true;
            document.querySelectorAll('.item-row').forEach(row => {
                const descripcion = row.querySelector('.item-descripcion').value;
                const precio = row.querySelector('.item-precio').value;
                if (!descripcion || !precio) { formularioValido = false; }
                items.push([descripcion, precio]);
            });

            if (!clienteInput.value || !equipoInput.value || !fallaInput.value || !formularioValido) {
                alert('Por favor, completa todos los campos: cliente, equipo, falla y los detalles de cada 칤tem.');
                return;
            }

            // 2. Guardar en LocalStorage (sin cambios)
            const proximoNumero = getProximoNumero();
            localStorage.setItem('ultimoPresupuestoId', proximoNumero);
            const nroFormateado = formatarNumero(proximoNumero);
            const fecha = fechaActualEl.textContent;
            
            try {
                // 3. --- 춰NUEVA L칍GICA! ---
                // Tomamos la "captura" del logo redondeado
                const logoElement = document.getElementById('logo-para-canvas');
                const canvas = await html2canvas(logoElement, {
                    backgroundColor: null // Mantiene la transparencia del PNG
                });
                const logoImgData = canvas.toDataURL('image/png');

                // 4. Generar el PDF
                const doc = new jsPDF();

                // --- DIBUJAR EL PDF ---
                
                // Logo (A침adimos la "captura" redonda)
                // Usamos 150x150px de la captura, escalado a 40x40mm en el PDF
                doc.addImage(logoImgData, 'PNG', 85, 10, 40, 40);
                
                // T칤tulo
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text("Tech-Fix", 105, 60, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text("Reparaci칩n y Mantenimiento de PC", 105, 65, { align: 'center' });

                // Informaci칩n de la empresa (izquierda)
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text("Tech-Fix", 14, 80);
                doc.setFont(undefined, 'normal');
                doc.text("Contacto: @tech.fix.ok | Tel: 3888343801", 14, 85);
                
                // N춿 y Fecha (derecha)
                doc.setFont(undefined, 'bold');
                doc.text(`Presupuesto N춿: ${nroFormateado}`, 196, 80, { align: 'right' });
                doc.text(`Fecha: ${fecha}`, 196, 85, { align: 'right' });

                // Datos del Cliente (secci칩n completa)
                doc.setFont(undefined, 'bold');
                doc.text("Cliente:", 14, 100);
                doc.text("Equipo:", 14, 105);
                doc.text("Falla a detallar:", 14, 110);
                doc.setFont(undefined, 'normal');
                doc.text(clienteInput.value, 45, 100);
                doc.text(equipoInput.value, 45, 105);
                doc.text(fallaInput.value, 45, 110);

                // Tabla de 칤tems
                doc.autoTable({
                    startY: 120,
                    head: [['Descripci칩n', 'Precio ($)']],
                    body: items,
                    headStyles: { fillColor: [0, 139, 186] },
                    theme: 'grid',
                });

                // Total
                const finalY = doc.lastAutoTable.finalY || 140;
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(`TOTAL: $ ${totalPresupuestoEl.textContent}`, 196, finalY + 15, { align: 'right' });

                // 5. Descargar el PDF
                doc.save(`Presupuesto-Tech-fix-${nroFormateado}.pdf`);

                // 6. Resetear el formulario
                inicializarFormulario();

            } catch (e) {
                console.error("Error al generar el PDF:", e);
                alert("Hubo un error al generar el PDF. Revisa la consola para m치s detalles.");
            }
        });

        // --- INICIALIZACI칍N DE LA APLICACI칍N ---
        inicializarFormulario();
    });
    </script>
</body>
</html>